<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>KHTC-UET - Qu·∫£n l√Ω t√†i li·ªáu</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #fdfbfb, #ebedee);
      font-family: 'Segoe UI', sans-serif;
      padding: 40px;
    }
    .container {
      max-width: 800px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    #roleInfo {
      font-weight: bold;
      margin-top: 15px;
    }
    .btn-primary, .btn-success {
      border-radius: 30px;
    }
    table {
      margin-top: 20px;
    }
    thead {
      background-color: #2980b9;
      color: white;
    }
    tbody tr:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h2>üè¢ KHTC-UET - Qu·∫£n l√Ω T√†i li·ªáu</h2>
    <button class="btn btn-primary" onclick="loginWithGoogle()">Google Login</button>
    <p id="roleInfo"></p>

    <div id="uploadSection" style="display:none;">
      <h4 class="mt-4">Upload File (Admin only)</h4>
      <input type="file" id="fileInput" accept=".pdf,.doc,.docx" class="form-control mt-2" />
      <button class="btn btn-success mt-2" onclick="uploadFile()">Upload</button>
      <p id="uploadResult" class="text-danger"></p>
    </div>

    <button class="btn btn-outline-secondary mt-4" id="getBtn" onclick="getFiles()" style="display:none;">Xem danh s√°ch File üìÇ</button>

    <table class="table table-striped" id="fileTable" style="display:none;">
      <thead>
        <tr>
          <th>T√™n File</th>
          <th>ƒê∆∞·ªùng d·∫´n</th>
          <th>Th·ªùi gian</th>
        </tr>
      </thead>
      <tbody id="fileTableBody"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwhqypZ4fU6wJCRwTN3JnclJlcQS1xGas",
      authDomain: "sso-project-dce86.firebaseapp.com",
      projectId: "sso-project-dce86",
    };
    firebase.initializeApp(firebaseConfig);

    function renderUI(role) {
      const roleInfo = document.getElementById("roleInfo");
      roleInfo.innerText = role === "admin"
        ? "üîë Vai tr√≤: Admin"
        : "üë§ Vai tr√≤: User";
      document.getElementById("uploadSection").style.display = role === "admin" ? "block" : "none";
      document.getElementById("getBtn").style.display = "inline-block";
    }

    let isLoggingIn = false;
    async function loginWithGoogle() {
      const loginButton = document.querySelector('.btn-primary');
      
      // Ki·ªÉm tra xem c√≥ ƒëang trong qu√° tr√¨nh ƒëƒÉng nh·∫≠p kh√¥ng
      if (isLoggingIn) {
        console.log("ƒêang trong qu√° tr√¨nh ƒëƒÉng nh·∫≠p, vui l√≤ng ƒë·ª£i...");
        return;
      }
      
      try {
        isLoggingIn = true; // ƒê√°nh d·∫•u ƒëang trong qu√° tr√¨nh ƒëƒÉng nh·∫≠p
        loginButton.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t ƒëƒÉng nh·∫≠p
        loginButton.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
        
        console.log("B·∫Øt ƒë·∫ßu ƒëƒÉng nh·∫≠p v·ªõi Google...");
        
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.setCustomParameters({
          prompt: 'select_account'
        });
        
        const result = await firebase.auth().signInWithPopup(provider);
        if (!result || !result.user) {
          throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c th√¥ng tin ng∆∞·ªùi d√πng t·ª´ Google");
        }
        const user = result.user;
        console.log("ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng, ƒëang l·∫•y token...");
        
        const token = await user.getIdToken(true);
        console.log("ƒê√£ l·∫•y ƒë∆∞·ª£c token:", token.substring(0, 20) + "...");
        localStorage.setItem("firebase_token", token);
        
        console.log("ƒêang g·ªçi API whoami...");
        const res = await fetch("http://127.0.0.1:8000/whoami", {
          method: "GET",
          headers: { 
            "Authorization": `Bearer ${token}`
          },
          mode: 'cors'
        });
        
        console.log("K·∫øt qu·∫£ API:", res.status, res.statusText);
        const data = await res.json();
        console.log("D·ªØ li·ªáu tr·∫£ v·ªÅ:", data);
        
        if (!res.ok) {
          throw new Error(JSON.stringify(data));
        }
        renderUI(data.role);
      } catch (e) {
        console.error("Chi ti·∫øt l·ªói:", e);
        alert("L·ªói ƒëƒÉng nh·∫≠p: " + e.message);
      } finally {
        // Lu√¥n reset tr·∫°ng th√°i v√† n√∫t sau khi ho√†n th√†nh
        isLoggingIn = false;
        loginButton.disabled = false;
        loginButton.textContent = 'Google Login';
      }
    }

    async function downloadFile(filePath, filename) {
      try {
        const token = localStorage.getItem("firebase_token");
        if (!token) {
          throw new Error("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i");
        }
        const res = await fetch(`http://127.0.0.1:8000/download${filePath}`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });
        if (!res.ok) {
          throw new Error("Kh√¥ng th·ªÉ t·∫£i file");
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } catch (error) {
        console.error("L·ªói t·∫£i file:", error);
        alert(error.message);
      }
    }

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Ch·ªçn file tr∆∞·ªõc.");
      
      try {
        const token = localStorage.getItem("firebase_token");
        if (!token) {
          throw new Error("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i");
        }
        
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch("http://127.0.0.1:8000/upload/", {
          method: "POST",
          headers: { 
            "Authorization": `Bearer ${token}`
          },
          body: formData
        });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.detail || "L·ªói upload file");
      }
      document.getElementById("uploadResult").innerText = "‚úîÔ∏è Upload th√†nh c√¥ng!";
      document.getElementById("fileInput").value = ""; // Reset file input
      getFiles(); // T·ª± ƒë·ªông refresh danh s√°ch file
    } catch (error) {
      console.error("L·ªói upload:", error);
      document.getElementById("uploadResult").innerText = "‚ùå " + error.message;
    }
  }

    async function getFiles() {
      const token = localStorage.getItem("firebase_token");
      if (!token) return alert("Ch∆∞a login");
      const res = await fetch("http://127.0.0.1:8000/files/", {
        method: "GET",
        headers: { 
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });
      const data = await res.json();
      if (!res.ok) return alert("L·ªói: " + JSON.stringify(data));
      const table = document.getElementById("fileTable");
      const tbody = document.getElementById("fileTableBody");
      tbody.innerHTML = "";
      data.forEach((file) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <a href="#" onclick="downloadFile('${file.file_path}', '${file.filename}')" style="text-decoration: none;">
              üìÑ ${file.filename}
            </a>
          </td>
          <td>${file.file_path}</td>
          <td>${new Date(file.uploaded_at).toLocaleString("vi-VN")}</td>
        `;
        tbody.appendChild(row);
      });
      table.style.display = "table";
    }
  </script>
</body>
</html>
